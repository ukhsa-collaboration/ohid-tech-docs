<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Talk to Frank - OHID Technical Documentation</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://ukhsa-collaboration.github.io/ohid-tech-docs/documentation/services/talktofrank.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="ukhsa-collaboration.github.io" />
      <meta name="twitter:image" content="https://ukhsa-collaboration.github.io/ohid-tech-docs/images/govuk-large.png" />
      <meta name="twitter:title" content="Talk to Frank - OHID Technical Documentation" />
      <meta name="twitter:url" content="https://ukhsa-collaboration.github.io/ohid-tech-docs/documentation/services/talktofrank.html" />

      <meta property="og:image" content="https://ukhsa-collaboration.github.io/ohid-tech-docs/images/govuk-large.png" />
      <meta property="og:site_name" content="OHID Technical Documentation" />
      <meta property="og:title" content="Talk to Frank" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://ukhsa-collaboration.github.io/ohid-tech-docs/documentation/services/talktofrank.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://ukhsa-collaboration.github.io/ohid-tech-docs" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          OHID Technical Documentation
        </span>
      </a>
        <strong class="govuk-tag">internal</strong>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide menu">Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="../../">Home</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ukhsa-collaboration/ohid-tech-docs">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://ukhsa-collaboration.github.io/ohid-tech-docs"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#talk-to-frank"><span>Talk to Frank</span></a>
    <ul>
      <li>
        <a href="#architecture-overview"><span>Architecture Overview</span></a>
      </li>
      <li>
        <a href="#components"><span>Components</span></a>
      </li>
      <li>
        <a href="#environments"><span>Environments</span></a>
      </li>
      <li>
        <a href="#email"><span>Email</span></a>
      </li>
      <li>
        <a href="#dns-overview"><span>DNS Overview</span></a>
      </li>
      <li>
        <a href="#common-issues"><span>Common issues</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="talk-to-frank">Talk to Frank</h1>
<p>Talk to Frank is a public-facing website offering drug advice for children and adults.</p>
<p>It is deployed on AWS using ECS, behind a CloudFront distribution and an ALB, which routes traffic to ECS containers.</p>
<p>The site integrates with AWS OpenSearch (formerly Elasticsearch) to power its drug search functionality. The frontend uses the headless CMS <a href="https://www.contentful.com/">Contentful</a> for its backend.</p>
<p>For the &lsquo;Find a support centre&rsquo; feature, Google&rsquo;s <a href="https://developers.google.com/maps/documentation/geocoding/overview">Geocoding API</a> is used.</p>
<p>Analytics are captured using self-hosted <a href="https://matomo.org/">Matomo</a> which runs in ECS containers.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><a href="../../images/talktofrank-architecture.png" rel="noopener noreferrer"><img src="../../images/talktofrank-architecture.png" alt="Talk to Frank architecture diagram" /></a></p>
<h2 id="components">Components</h2>
<h3 id="application">Application</h3>

<ul>
<li><strong>Repo:</strong> <a href="https://github.com/ukhsa-collaboration/talk-to-frank">talk-to-frank (Next.js app)</a></li>
<li>The frontend application built with Next.js.</li>
</ul>
<h3 id="infrastructure-as-code-iac">Infrastructure as Code (IaC)</h3>

<ul>
<li><strong>Repo:</strong> <a href="https://github.com/ukhsa-collaboration/talk-to-frank-iac">talk-to-frank-iac</a></li>
<li>Terraform code defining AWS infrastructure for all environments.</li>
</ul>
<h3 id="matomo">Matomo</h3>
<p>Self-hosted <a href="https://matomo.org/">Matomo</a> is used for analytics. It runs in both staging and production. The Matomo instance uses a MySQL RDS database and EFS storage for sharing application config data between the containers.</p>
<p>There is a scheduled ECS task that runs the Matomo archiver every hour.</p>
<h2 id="environments">Environments</h2>
<div class="table-container">
        <table>
          <tr>
<th>Environment</th>
<th>URL</th>
</tr><tr>
<td><strong>Production</strong></td>
<td>https://www.talktofrank.com</td>
</tr><tr>
<td><strong>Staging</strong></td>
<td>https://staging.talktofrank.com</td>
</tr><tr>
<td><strong>Preview</strong></td>
<td>https://preview.talktofrank.com</td>
</tr>
        </table>
      </div><h2 id="email">Email</h2>
<p>Emails to <code>frank@talktofrank.com</code> are received by Amazon SES. This puts the emails into an S3 bucket which then triggers a Lambda function. The Lambda function code is in the <a href="https://github.com/ukhsa-collaboration/talk-to-frank-iac/blob/main/applications/app/modules/ses/src/index.py">IaC repo</a> as it is temporary. This Lambda checks if SES has flagged the email as spam. If it is marked as spam then the Lambda moves the email from <code>{bucketname}/mailbox/frank@talktofrank.com</code> to <code>{bucketname}/processed/frank@talktofrank.com</code>.</p>
<p>If the email isn&rsquo;t marked as spam, the email is forwarded onto some email addresses at DHSC. These email addresses are defined in the Lambda.</p>
<p>In the future, this should be changed so that DHSC add talktofrank.com as a domain to their Microsoft Azure tenant. We would need to help by adding the correct MX records and verifying the domain for them but this would remove the Heath Robison-esque way of handling emails and allow the DHSC users to reply to emails, etc.</p>
<h2 id="dns-overview">DNS Overview</h2>
<p>The domain is registered with a third-party DNS registrar. The talktofrank.com domain is delegated to a Route 53 zone in AWS. This zone then delegates to the other accounts</p>

<ul>
<li>preview.talktofrank.com – TalktoFrank Dev</li>
<li>staging.talktofrank.com – TalktoFrank UAT</li>
<li>talktofrank.com – TalktoFrank Production</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>graph TD;
    DEV[preview.talktofrank.com&lt;br&gt;dev account]
    UAT[staging.talktofrank.com&lt;br&gt;uat account]
    PRD[talktofrank.com&lt;br&gt;prd account]

    PRD --&gt; DEV
    PRD --&gt; UAT
</code></pre></div><p>Each environment (account) manages its own hosted zone via Terraform.</p>
<p>If zones are recreated for any reason, the corresponding NS records must be updated in the phe-root account to point to the new name servers of the environment-specific hosted zone.</p>
<h2 id="common-issues">Common issues</h2>
<h3 id="no-search-results-in-the-look-up-a-drug-feature">No Search Results in the ‘Look Up a Drug’ Feature</h3>
<p>This may be caused by missing or incomplete OpenSearch content. In this case, ensure that the index is correctly populated with the expected drug data. Another possibility is a connectivity issue between ECS and OpenSearch; make sure the ECS service has network access to the OpenSearch domain, including correct security group and VPC configuration.</p>
<h3 id="error-when-finding-a-support-centre">Error When Finding a Support Centre</h3>
<p>This could be due to connectivity issues with Contentful or a failure in the Geocoding API lookup when resolving postcodes to geographic coordinates. Check that both APIs are reachable, the API keys are valid, and requests are not hitting usage limits or returning errors. It&rsquo;s also worth verifying that the postcode input is being correctly parsed and encoded before the API call, as malformed or incomplete requests can result in failed lookups. Ensure that CloudFront (or other tool) is not stripping query parameters from the URL before the request reaches the application container. For example, a request to /treatment-centre?location=N1%208AD&amp;serviceType=&hellip; must not be rewritten or truncated to just /treatment-centre.</p>
<h3 id="updated-environment-variables-and-restarted-containers-but-changes-not-reflected-on-website">Updated environment variables and restarted containers but changes not reflected on website</h3>
<p>Because of how the <code>NEXT_PUBLIC_</code> environment variables are added to the NodeJS container, the Cloudfront cache may need invalidating as it may be caching Javascript files with old values. See AWS instructions for this: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Invalidation_Requests.html</p>

            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ukhsa-collaboration/ohid-tech-docs/blob/main/source/documentation/services/talktofrank.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ukhsa-collaboration/ohid-tech-docs/issues/new?body=Problem+with+%27Talk+to+Frank%27+%28https%3A%2F%2Fukhsa-collaboration.github.io%2Fohid-tech-docs%2Fdocumentation%2Fservices%2Ftalktofrank.html%29&amp;labels=bug&amp;title=Re%3A+%27Talk+to+Frank%27">Report problem</a></li>
                <li><a href="https://github.com/ukhsa-collaboration/ohid-tech-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
